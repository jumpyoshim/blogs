# 概要

- 著作： **「ElasticSearch 実践ガイド」**
- 著者： **惣道 哲也**
- 著者経歴：1998 年に日本ヒューレット・パッカード株式会社に入社。半導体テスタのソフトウェア開発を担当し、その後、主に通信・金融系システムのインフラ構築・アプリケーション開発・プロジェクトマネージャに従事。2012 年より主にオープンソースソリューションの提案・設計・導入・技術コンサルティングを行う組織にて、Hadoop、クラウド、コンテナ/DevOps、Deep Learning 分野におけるテクニカルアーキテクトとして活動している。また、社内では全社横断的な技術コミュニティの日本担当リーダとして技術啓蒙を行うかたわら、社外でも数々のイベント・セミナーや技術コミュニティで登壇している。

# 要約

Elasticsearch は索引検索型の全文検索を行うソフトウェア。検索性能や可用性が高い。また、REST API でリソースの操作が行える柔軟性の高さも兼ね備える。さらに、Elastic Stack と連携することでログ収集や可視化などができる。

# 感想

全文検索を単語を初めて知ったが非常に興味深かった。膨大なデータから特定のデータを瞬時に見つけなければいけないので、難しそうな仕組みなのかなという勝手な印象があったが、意外とシンプルなシステム構成だということがわかった。Elasticsearch の直感的な インターフェースはとても使いやすい。Elasticsearch に入門できるよい書籍だった。さらに手を動かして実践的なノウハウ身に付けていきたい。

# 目的

Elasticsearch のセマンティックを理解する

# 質問

- Elasticsearch とは何か
- Elasticsearch の優位性
- 全文検索とは何か
- どのような API を提供するのか
- Analyzer とは何か
- Aggeregation とは何か
- スクリプティングとは何か

# 回答

## Elasticsearch とは何か

- 概要
  - 索引検索型の全文検索を行う Java 製のソフトウェア
  - 2010 年に登場。全文検索システムとしては後発
  - 検索ライブラリ（インデクサとサーチャー）と API やクラスタ管理を提供する検索サーバ
  - 検索ライブラリとして Lucene を利用している
  - Shay Banon によって 2004 年から開発されていた Compass という検索ソフトウェアが前身となっている
    - 妻の料理レシプを検索するためのアプリケーションとして開発された
  - Elastic 社によって開発が行われている
- 特徴
  - 分散配置による高速化と高可用性の実現
    - 高速化
      - インデックスの内部ではシャードという単位で分割して格納され、デフォルトで 5 つのシャードに分散配置される
      - インデックスの検索が分散処理されて並列で行えるため、検索性能が向上する
      - ノードを追加した際のシャードの再構成はすベて自動的に行われる
    - 高可用性
      - 各シャードに対してレプリカを 1 つ以上持たせることができる
      - ノードが１台ダウンしてしまってもレプリカを元に自動復旧することができる
  - シンプルな REST API によるアクセス
    - 全ての操作を REST API 上で行うことができる
  - JSON フォーマットに対応した柔軟性の高いドキュメント指向データベース
    - インデックス対象のドキュメント、検索クエリ、検索結果など全て JSON を用いる
    - スキーマレス、スキーマフリー
      - スキーマを定義せずにインデックスをした場合、格納するデータの値をみて自動的にデータの型を推論してくれるのでスキーマがないわけではない
  - ログ収集・可視化などの多様な関連ソフトウェアとの連携
    - Elastic Stack
      - 可視化：Kibana
      - ログ収集：Logstash
      - メトリクスデータの収集：Beats
    - X-Pack
      - セキュリティ、監視・モニタリング、機械学習による以上検知などの有償アドオンモジュール
- ユースケース
  - 全文検索
  - アクセスログとアプリケーションログの分析
  - 分散システムの横断ログ検索
  - 以上検知
  - IoT デバイスのセンサデータの可視化
- 導入事例
  - GitHub, Netflix, CERN etc...
    - [https://www.elastic.co/jp/customers/](https://www.elastic.co/jp/customers/)
- 論理的概念
  - ドキュメント
    - Elasticsearch に格納する 1 つの文章の単位（RDB でいうレコードに該当）
  - フィールド
    - ドキュメントを構成する key-value の組
    - 型の種類
      - 文字列: text, keyword
        - text は格納時に Analyzer によって文章を形態素解析され転置インデックスが構成される
        - keyword は格納した文字列を完全一致で検索する用途で用いる。Analyzer による処理が行われない
      - 数値: long, short, integer, float など
      - 日付: date
        - UNIX エポックからのミリ秒数での表記や ISO8601 形式での表記
      - 真偽値: boolean
      - オブジェクト: object
      - 配列: array
  - インデックス
    - ドキュメントを保存する場所
    - 文書を Analyzer によって単語分割したり、転置インデックスを構成したりして様々なデータ形式で保存する
    - 一定数のシャードに分割されて各ノードに分散して格納される
  - ドキュメントタイプ
    - ドキュメントがどのようなフィールドから構成されているか、という構造を表す概念
  - マッピング
    - ドキュメントタイプを具体的に定義したものとして、ドキュメント内の各フィールドのデータ構造やデータ型を記述した情報
- 物理的概念
  - ノード
    - Elasticsearch が動作する各サーバのこと
  - クラスタ
    - 強調して動作するノードグループのこと
  - シャード
    - ノード内でインデックスを分散保持する単位
  - レプリカ
    - シャード（ノード）の可用性を高めるために自動的に作成される複製
    - 特にオリジナルのシャードをプライパリシャード、複製されるシャードをレプリカシャードと呼ぶ

## Elasticsearch の優位性

- Elasticsearch と類似してよく比較される全文検索ソフトウェアに Apache Solr がある
  - 両者に大きな機能差はない
- DB-ENGINS の指標

  - ソフトウェアに言及しているサイトの数、Google Trends の傾向、求職数などを元にして総合的にスコアリング

  ![Screen_Shot_0001-09-25_at_8.54.18.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/160547/239bb892-c103-2c74-9b22-6230705ac988.png)

## 全文検索とは何か

- 概要
  - 複数の文書にまたがって特定の文字列をキーに目的の文書を探すための方式
  - 全文検索を実現する方法として逐次検索と索引検索がある
    - 逐次検索とは？
      - 全文書を対象にファイルの内容を順次走査しながら目的の文字列を探す方法。
      - シンプルだが検索対象となる文章の和也量が大きいと現実的な時間内に処理が完了しないことがある。
    - 索引検索とは？
      - 事前に高速に検索できるような索引（インデックス）を構成しておいて、検索時にはこの索引をキーに目的の文書を探す方法。
      - 検索対象が大きい場合はこちらの方法が選択される。
      - 一般的に用いられる形式は転置インデックス。転置インデックスとは、単語とその単語が出現する文書（文書 ID）の組み合わせをインデックスとして構成する方式。
- 背景
  - 1990 年代になると、WWW の利用が広がるとともにインターネット上の膨大なサイトから目的の情報を探し出すための検索システムが発達してきた
- システム構成
  - インデクサ（indexer）
    - 対象ドキュメントから検索キーワードとなる単語を抽出したインデックスデータベース
  - サーチャー（searcher）
    - インデクサに対しての検索クエリ機能
    - Java API や REST API などのインターフェースを提供する
  - クローラー（crawler）
    - 定期的に検索対象を巡回してドキュメントをインデクサに渡してインデックスを更新する

## どんな API を提供するのか

- 各リソース（ドキュメント、インデックス、マッピングテンプレートなど）に対する基本的な CRUD 操作ができる
- クエリ
  - クエリ DSL
    - 検索をする際に記述する JSON オブジェクトのフォーマット
  - URI サーチ
    - 簡易なクエリ記法

## Analyzer とは何か

- 全文検索を行うために文章を単語の単位に分割する処理機能のこと
- 日本語形態素解析用のプラグインとして kuromoji Analysis Plugin がある
- 表記ゆれに対処するため単語分割の際に表現を揃えることを目的とした処理がある
  - ステミング
  - 正規化
  - ストップワード
  - 上記のような対策を行うことで検索の精度を向上させる

## Aggeregation とは何か

- 検索結果の集合に対して分類や集計を行うことができる機能
- ドキュメントを特定のグループに分類することができ、さらにそのグループごとの件数、最大値、平均値といった統計量の値を返すことができる

## スクリプティングとは何か

- スコアの計算、データのフィルタや分析、ドキュメントの部分的な更新ができる
- デフォルトのスクリプティング言語として Painless が使われる
